steps:
  - id: 'build'
    name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'Dockerfile', '-t', 'us.gcr.io/${PROJECT_ID}/${_SERVICE}', '.']

  - id: 'push'
    name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us.gcr.io/${PROJECT_ID}/${_SERVICE}']

  - id: 'migrate'
    name: 'gcr.io/google-appengine/exec-wrapper'
    args: ['-i', 'us.gcr.io/${PROJECT_ID}/${_SERVICE}',
           '-s', '${PROJECT_ID}:${_REGION}:${_INSTANCE_NAME}',
           '-e', 'PROJECT_ID=${PROJECT_ID}',
           '-e', 'APP_ENV=${_APP_ENV}',
           '-e', 'APP_DEBUG=${_APP_DEBUG}',
           '--', 'php', '/app/artisan', 'migrate', '--force']

  - id: 'deploy '
    name: 'gcr.io/cloud-builders/gcloud'
    args: ["run", "deploy", "${_SERVICE}",
           "--platform", "managed",
           "--region", "${_REGION}",
           "--image", "us.gcr.io/${PROJECT_ID}/${_SERVICE}"]